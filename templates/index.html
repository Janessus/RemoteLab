<html>
  <head>
    <title>Video Streaming Demonstration</title>
  </head>
  <body>
    <h1>Video Streaming Demonstration</h1>
    <img id="bg" src="{{ url_for('video_feed') }}">

    <div id="inputContainer">
      <script>
      function sendJSON(type, value){

            // Creating a XHR object
            let xhr = new XMLHttpRequest();

            // open a connection
            xhr.open("POST", "/input", true);

            // Set the request header i.e. which type of content you are sending
            xhr.setRequestHeader("Content-Type", "application/json");

            // Converting JSON data to string
            var data = JSON.stringify({ "userName": "Alice", "messageType": "input", "inputType": type, "portValue": value });

            // Sending data with the request
            xhr.send(data);
        }
    </script>

      <div id="buttons">
        <h1>Buttons</h1>
        <button name="buttons" value="1" onclick="sendJSON(this.name, this.value)">B0</button>
        <button name="buttons" value="2" onclick="sendJSON(this.name, this.value)">B1</button>
        <button name="buttons" value="4" onclick="sendJSON(this.name, this.value)">B2</button>
        <button name="buttons" value="8" onclick="sendJSON(this.name, this.value)">B3</button>
        <button name="buttons" value="16" onclick="sendJSON(this.name, this.value)">B4</button>
        <button name="buttons" value="32" onclick="sendJSON(this.name, this.value)">B5</button>
        <button name="buttons" value="64" onclick="sendJSON(this.name, this.value)">B6</button>
        <button name="buttons" value="128" onclick="sendJSON(this.name, this.value)">B7</button>
      </div>

      <div id="switches">
        <h1>Switches</h1>
        <button name="switches" value="1" onclick="sendJSON(this.name, this.value)">S0</button>
        <button name="switches" value="2" onclick="sendJSON(this.name, this.value)">S1</button>
        <button name="switches" value="4" onclick="sendJSON(this.name, this.value)">S2</button>
        <button name="switches" value="8" onclick="sendJSON(this.name, this.value)">S3</button>
        <button name="switches" value="16" onclick="sendJSON(this.name, this.value)">S4</button>
        <button name="switches" value="32" onclick="sendJSON(this.name, this.value)">S5</button>
        <button name="switches" value="64" onclick="sendJSON(this.name, this.value)">S6</button>
        <button name="switches" value="128" onclick="sendJSON(this.name, this.value)">S7</button>
      </div>
    </div>

    <div id="uploadContainer">
      <style>
        #progress_bar {
          margin: 10px 0;
          padding: 3px;
          border: 1px solid #000;
          font-size: 14px;
          clear: both;
          opacity: 0;
          -moz-transition: opacity 1s linear;
          -o-transition: opacity 1s linear;
          -webkit-transition: opacity 1s linear;
        }
        #progress_bar.loading {
          opacity: 1.0;
        }
        #progress_bar .percent {
          background-color: #99ccff;
          height: auto;
          width: 0;
        }
      </style>

      <input type="file" id="files" name="file" />
      <div id="progress_bar"><div class="percent">0%</div></div>

      <script>
        var reader;
        var progress = document.querySelector('.percent');


        function upload() {
          var data = JSON.stringify({ "userName": "Alice", "messageType": "upload", "file": reader.result });
          var xhr = new XMLHttpRequest();

          xhr.open('POST', '/upload', true);
          // Set the request header i.e. which type of content you are sending
          xhr.setRequestHeader("Content-Type", "application/json");
          xhr.send(data);
        }

        function errorHandler(evt) {
          switch(evt.target.error.code) {
            case evt.target.error.NOT_FOUND_ERR:
              alert('File Not Found!');
              break;
            case evt.target.error.NOT_READABLE_ERR:
              alert('File is not readable');
              break;
            case evt.target.error.ABORT_ERR:
              break; // noop
            default:
              alert('An error occurred reading this file.');
          };
        }

        function updateProgress(evt) {
          // evt is an ProgressEvent.
          if (evt.lengthComputable) {
            var percentLoaded = Math.round((evt.loaded / evt.total) * 100);
            // Increase the progress bar length.
            if (percentLoaded < 100) {
              progress.style.width = percentLoaded + '%';
              progress.textContent = percentLoaded + '%';
            }
          }
        }

        function handleFileSelect(evt) {
          // Reset progress indicator on new file selection.
          progress.style.width = '0%';
          progress.textContent = '0%';

          reader = new FileReader();
          reader.onerror = errorHandler;
          reader.onprogress = updateProgress;

          reader.onloadstart = function(e) {
            document.getElementById('progress_bar').className = 'loading';
          };

          reader.onload = function(e) {
            // Ensure that the progress bar displays 100% at the end.
            progress.style.width = '100%';
            progress.textContent = '100%';
            setTimeout("document.getElementById('progress_bar').className='';", 2000);
            upload(reader.result);
          }

          // Read in the image file as a binary string.
          reader.readAsBinaryString(evt.target.files[0]);
        }

        document.getElementById('files').addEventListener('change', handleFileSelect, false);
      </script>
    </div>
  </body>
</html>
